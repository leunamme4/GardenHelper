name: Android Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, local, android]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: Set ANDROID_HOME
        run: |
          $env:ANDROID_HOME="C:\Users\overpower\AppData\Local\Android\Sdk"
          echo "ANDROID_HOME=$env:ANDROID_HOME" >> $env:GITHUB_ENV

      - name: Build Debug APK
        shell: powershell
        run: .\gradlew assembleDebug

      - name: Connect to Android Emulator
        shell: powershell
        run: |
          if (-not (adb devices | Select-String "emulator")) {
              adb connect localhost:5555
          } else {
              Write-Host "Already connected"
          }

      - name: Wait for Android Emulator
        shell: powershell
        run: |
          $maxRetries = 30
          $retry = 0
          while ($retry -lt $maxRetries) {
              $emulator = adb devices | Select-String "emulator"
              if ($emulator) {
                  Write-Host "Emulator is ready!"
                  break
              } else {
                  Write-Host "Emulator not ready, retry $($retry + 1)..."
                  Start-Sleep -Seconds 5
                  $retry++
              }
          }

          if (-not $emulator) {
              Write-Host "Emulator did not become ready in time"
              exit 1
          }

      - name: Install APK on Emulator
        shell: powershell
        run: |
          $apkPath = Get-ChildItem -Path .\app\build\outputs\apk\debug\*.apk | Select-Object -First 1
          if (-not $apkPath) {
              Write-Host "APK not found!"
              exit 1
          }

          Write-Host "Installing APK: $($apkPath.FullName)"
          $maxRetries = 5
          $retry = 0
          while ($retry -lt $maxRetries) {
              $res = adb install -r $apkPath.FullName
              if ($res -match "Success") {
                  Write-Host "APK installed successfully!"
                  break
              } else {
                  Write-Host "Retry $($retry + 1): install failed, retrying in 5s..."
                  Start-Sleep -Seconds 5
                  $retry++
              }
          }

          if ($retry -eq $maxRetries) {
              Write-Host "Failed to install APK after $maxRetries attempts"
              exit 1
          }
